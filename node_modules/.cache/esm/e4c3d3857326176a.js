let Joi,JwtService,CustomErrorHandler,User,RefToken,bcrypt,JWT_REF_SECRET,refToken;_732‍.x([["default",()=>_732‍.o]]);_732‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_732‍.w("../../services.js",[["JwtService",["JwtService"],function(v){JwtService=v}],["CustomErrorHandler",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_732‍.w("../../models",[["User",["User"],function(v){User=v}],["RefToken",["RefToken"],function(v){RefToken=v}]]);_732‍.w("bcrypt",[["default",["bcrypt"],function(v){bcrypt=v}]]);_732‍.w("../../config",[["JWT_REF_SECRET",["JWT_REF_SECRET"],function(v){JWT_REF_SECRET=v}]]);_732‍.w("../../models/refToken.js",[["default",["refToken"],function(v){refToken=v}]]);






const loginController = {
  async login(req, res, next) {
    // validation
    const loginSchema = Joi.object({
      email: Joi.string().email().required(),
      password: Joi.string().required(),
    });

    const { error } = loginSchema.validate(req.body);

    if (error) {
      return next(error);
    }

    const { email, password } = req.body;

    try {
      const user = await User.findOne({ email });

      if (!user) {
        return next(CustomErrorHandler.invalidCredentials());
      }

      const match = await bcrypt.compare(password, user.password);

      if (!match) {
        return next(CustomErrorHandler.invalidCredentials());
      }

      const _id = user._id;

      const accessToken = JwtService.sign({ _id });
      const refToken = JwtService.sign({ _id }, "1y", JWT_REF_SECRET);

      await RefToken.create({ refToken });

      res.json({ accessToken, refToken });
    } catch (err) {
      return next(err);
    }
  },

  async logout(req, res, next) {

    const tokenSchema = Joi.object({
      refToken: Joi.string().required(),
    });

    const { error } = tokenSchema.validate(req.body);

    if (error) {
      return next(error);
    }

    const { refToken } = req.body;
  
    try {
      await RefToken.deleteOne({refToken});

      res.json({message: "Logout successfully"});
    } catch (err) {
      return next(new Error("Something went wrong"));
    }
  },
};

_732‍.d(loginController);
